漢文はご存んｊ……日本の皆さん、日本で中高の教育を受けた皆様なら、漢文訓読というものには苦しｍ……たくさん教養を高められたことでしょう。私は日本で初等教育や中等教育を受けたことはありませんが、専門的に日本語の古文や漢文を叩き込まれました、というより、結構面白いので現代日本語とほぼ同じ時期から勉強を初めた感じです。

漢文訓読というのは、要は日本伝統的な中国語解読術である。中国語というのも、「ニーハオ」とか言っている現代中国語の普通話ではなく、中華文明に発祥し、漢字文化圏（中日韓越）の人々によって何千年も利用されてきた伝統的な書記言語であり、つい百年前でも教養がある人であれば文字を書けばこれでコミュニーケーションが取れるくらいでしたし、現代でも色んなところでまだ学校教育に多少取り込まれています。まあ今でいう英語やアラビア数字、数学の数式に相当するものでしょうか。古典中国語とでも呼べばいいでしょうか。その原型は二千～三千年前に話されていた上代中国語（上古漢語）であり、独自の語彙体系や文法を持つ。話し言葉が速いスピードで変化しているのにもかかわらず、書記言語ではある程度安定して千年に渡って変化はあれど概ね同じ言語と言えるほどに安定していて、それや古典中国語で書かれたものによって周辺のあらゆる言語・文化に影響を与えてきました。

もちろん、古代の日本語話者たちも古典中国語の影響下にあり、未だに日本語の表記体系に色濃く特性が残されています。そうした漢文を日本語でも読みたいと、当時の日本人は思ったのでしょうか。こうして、周辺文化の影響を受けながら、訓点と呼ばれる特殊な記号が段々発達し、特定なルールに従えば、漢文を機械的に当時の古典日本語の体系に翻訳することができるようになり、そうして漢文訓読というものが生まれました。そうしたルールを今でも中高の受験や、大学の講義などで伝授され、着々と受け継がれてきました。

そこで、組版技術がどんどん発展してきた今でも、漢文や訓点を組版する需要があります。今まではワープロ、LaTeX、HTMLなど、様々な組版エンジンで有志により漢文が実装されておりますが、Typstではまだ縦書きが現時点（v0.14）公式的にサポートされてはいませんが、横書きの文章に漢文を入れるという需要もないわけではないし、例え縦書きがサポートされていたとしても、漢文専用の組版ルールを実現するためにも、専用の実装が必要ですし、私はTypstでも漢文を組んでみたいと、数年前から思っていたので、ちょうど先延ばしたくなるような締切があったので（？？？）逃げて漢文訓読用のパッケージを2日で実装してみました。

その成果としてパッケージとして公開しておりますので、すぐに使ってみたい方は、以下のリンクから詳細をご覧ください。

https://github.com/mkpoli/hundouk

### Typstとは

Typstとは何かを、この文章を読んでいる皆様にわざわざ説明するまでもないとは思いますが、簡単に言えばプログラミング言語で文字や画像、図表などを並べて、文章を作れる組版エンジンです。最初はモダンな技術でLaTeXを代替できるように、学術論文を執筆するツールという目的で作られていたのですが、実際にはあらゆる用途で使えることが発見され、あらゆる分野で使われるようになりつつあります。

日本語話者向けでTypstを説明するのは、Zennや他の技術ブログサイト、または検索エンジンでTypstと検索すればたくさん優秀な文章が出てくるでしょう。私がこれ以上長々と説明することほど無駄なことはないでしょうから、1つだけ[最後で紹介される我々「くみはんクラブ」Discordコミュニティ](#コミュニティ)にも関わっている、Typstの公認非公式日本語ドキュメントをご覧になってみてください。

https://typst-jp.github.io/docs/

## 要件定義

漢文を組む、漢文訓読を組版する、訓点をつけるとは一体なんのことを言っているのでしょうか。組版された漢文とはどのようなものでしょうか。という質問を最初から考えてみました。まず、組まれた漢文の形を見てみました。

![漢文の組版例（Google画像検索）](https://storage.googleapis.com/zenn-user-upload/8fa24ffc00e1-20260102.png)

具体的にはGoogle画像検索や手元の本、受験勉強の参考書など、あらゆるところからまず漢文訓読の形を観察してみました。どういうものかというと、基本的には縦書きの漢字がメインで、そして横に変な記号が特定な位置にいろいろついていて、改行したりしなかったりするというようなものです。どうやらみんながみんあ完全に一緒のフォーマットというわけでも、当たり前ですが、ないのです。でも概ね似たようなルールに従って組版されているようなので、それを再現してみようというのは今回の目標です。

次に、漢文をどうやって組めばいいのかについて、色々調べてみました。  

### jlreq（日本語組版処理の要件）
日本語の組版の実装に応っては、かならず参照しなければならない資料としては、千葉 et al. (2020), _Requirements for Japanese Text Layout_（日本語組版処理の要件、略してjlreq）が挙げられます。「CSS，SVG，XSL-FOおよびeBookなどの技術で実現が求められる一般的な日本語組版の要件を記述した文書」と説明があるように、主にW3Cに関わる、ウェブ上のあらゆる技術において、日本語の組版について説明したものです。

W3C Working Group Note 11 August 2020 (2026年1月2日アクセス)
https://www.w3.org/TR/jlreq/
W3C Editor's Draft 14 August 2025 (2026年1月2日アクセス)
https://www.w3.org/International/jlreq/

後者の現時点での最新版について、漢文への言及をまず調べたが、二箇所しか当たりませんでした。

1つ目は[3.3.9 圏点の処理](https://www.w3.org/International/jlreq/?lang=ja#composition_of_emphasis_dots)にて注の中で「圏点を付ける方法はやや少ないが，漢文等では古くからで使用されており，歴史のある伝統的な方法である．」と圏点の説明で例として一部言及されたのみです。

2つ目は[G. 用語集](https://www.w3.org/International/jlreq/?lang=ja#terminology)にて _kanbun composition_ の項目があり、以下のように記述されています。

| 用語（英語） | 用語（日本語） | よみ | 定義 |
| ----------- | ------------ | ---- | ---- |
| …… | …… | …… | …… |
| kanbun composition | 漢文 | kanbun<br>かんぶん | 中国の古典文（又はそれにならった文体の文）について，日本語の文として読むことが可能になるように，読むための様々な補助記号を付けた文．|
| …… | …… | …… | …… |

次に、漢文の組版に関わる要素（縦組・ルビ・圏点）などについての記述はもちろんありました。

- 縦組（たてぐみ、vertical writing mode）即ち縦書きは、漢文のみならず、日本語（やほかの漢字文化圏）の伝統的な書字方向であり、[G. 用語集](https://www.w3.org/International/jlreq/?lang=ja#terminology)では「行においては文字を垂直方向に上から下へ，ページにおいて行を右から左へ，段を上から下へ配列すること．また，そのように文字が配置された状態．（JIS Z 8125）」とあります（孫引き）。


### 漢文の処理に関する記述

小林　敏

漢文の句読点や返り点の配置処理
https://www.jagat.or.jp/archives/21315
https://kambun.jp/izanai/04-13kunten.htm

https://exword.jp/function/feature_2018/reference_46_z.html

どうやらアキ組とベタ組のように、間隔の置き具合も少なくとも二種類の方法があるようです。

## 先行研究

そして実際どのようなツールを使って組版されてきたのでしょうか。

### Typstの縦書き

Typstは現時点（v0.12~0.14）では、公式には縦書き（Vertical Writing）をサポートしていません。ロードマップにはあるものの、まだ実装されていないのが現状です。

`rotate`関数を使って紙面全体を回転させた上で、テキストを一文字ずつ回転させて並べるか。または、Typstの字間行間を全無視して、`stack`や`grid`などの関数でゼロから組版エンジンの中の組版エンジンを組み直すことしか出来ません。このように現状では力技で擬似的に再現することしかできませんので、将来的に公式からCJKサポートのさらなる発展を期待するばかりです。

なお、句読点などの約物の回転を含む縦書きと横書きで形が変わるものを司る`vert`という縦書き用バリアントのOpenType機能（feature）は`text(feat: ("vert",))`でできるので、その点は心配しなくて済みそうです。

そして、たとえ縦書き機能がサポートされていたとしても、ルビや傍点の配置、そして何より漢文特有の返り点や送り仮名の複雑なレイアウトを考えると、単純な縦書き対応だけでは不十分であり、どの道専用パッケージを作らないといけないし、まだTypstで漢文を組む前例が乏しいということで、とりあえず実装の一例として磚を拋げて玉を引くとしましょう。

### WordPress / HTML (CSS)

ウェブ上では、`writing-mode: vertical-rl`というCSSプロパティを使えば、比較的簡単に縦書きを実現できます。これを利用した漢文表示の試みも多く、例えば青空文庫形式の注記をHTMLに変換するツールなどがあります。しかし、漢文特有の記号（レ点や一二点）の微調整や、送り仮名の位置（親文字の右側に付くか、送るか）の制御は、標準的なCSSだけでは難しい場合があります。

### 一太郎 / Word

もちろん、一太郎やWordなどのワープロソフトには強力な縦書き機能と、ある程度の漢文サポート（ルビや組み文字など）があります。しかし、これらはGUIベースでの操作が基本であり、プログラマブルに大量のテキストを処理したり、バージョン管理したりするには不向きです。やはり「コードで書いて組版する」という快感（？）は得られません。

### LaTeX (gckanbun / sfkanbun / kanbun.stl / kanbun)

LaTeX界隈では、古くから漢文組版のためのパッケージが開発されてきました。`gckanbun`や`kanbun`などが有名です。これらは非常に高品質な組版が可能ですが、LaTeX特有の記号やマクロを駆使する必要があり、初学者には少し敷居が高いかもしれません。また、命令型であるため、ソースコードが可読性が低くなりがちです。

### kanbunHTML

私の仲間の一人でもあるunt氏によって作られたものです。ウェブベースで非常に綺麗に漢文を表示できるツールですが、やはりTypstでPDFとして出力したいという欲求とはまた別のベクトルです。

### なぜTypstなのか

そこでTypstです。Typstはマークアップが軽量で、関数型プログラミングのような柔軟性を持っています。これを使えば、「直感的に書ける」かつ「綺麗に組める」漢文パッケージが作れるのではないかと考えました。

## 実装詳細

### 基本方針：グリッドレイアウト

まず Typst ではものを並べるために、`stack()`という一方向の関数と、`grid()`という2Dの関数がある。基本的には漢字とその周辺の訓点を1つとして考え、それらを縦方向に並べるということになります。

これを一つの「ユニット」として捉え、各漢字に対して局所的なグリッドを定義することにしました。

イメージとしてはこんな感じです：

```typst
grid(
  columns: (auto, auto, auto), // 左（返り点など）、中（親文字）、右（ルビ・送り仮名）
  rows: (auto, auto, auto),    // 上、中、下
  ...
)
```

このグリッドを縦方向（`stack(dir: ttb)`）に積み上げていけば、擬似的な縦書き漢文が完成します。

### 訓点の配置ロジック

一番の難所はやはり訓点の配置です。特に「送り仮名」と「返り点」が競合する場合や、ハイフン（―）で繋がれた熟語に対する返り点の位置などです。

本パッケージ`hundouk`では、以下のようなロジックで解決しています：

1.  **パース**: 入力されたテキスト（漢文）をパースし、親文字とそれに付随するアノテーション（読み、送り、返り点）をオブジェクトとして抽出します。
2.  **グルーピング**: 熟語（二字以上のつながり）などを必要に応じてグループ化します。
3.  **グリッド生成**: 各文字に対して、必要なサイズ（アキ組かベタ組かなど）を計算し、グリッドのセルに配置します。特に右側のルビ・送り仮名と、左側の返り点のバランスを取るために、グリッドの列幅を動的に制御しています。

特に苦労したのは「レ点」の扱いです。レ点は下の文字から上の文字へ返るため、Typstの標準的なフロー（上から下）とは逆の動きを視覚的に表現する必要があります。これは、レ点が付く文字とその次の文字を一度バッファし、グリッド内で位置を微調整することで実現しました。また、ハイフン（―）が入る場合、レ点がそのハイフンの位置まで「移動」したりする挙動も実装する必要がありました。

### 構文の工夫

利用者が書きやすいように、入力構文も工夫しました。独自パーサーを実装し、以下のように書けるようにしました。

```typst
#kundoku("子[シ]曰[イハ]ク")
```

このように、`[ ]`を使って直感的にルビや送り仮名を記述できるようにしています。

## パッケージの公開

こうして完成したのが、Typst用漢文組版パッケージ「**hundouk**（訓読）」です。

<https://github.com/mkpoli/hundouk>

### インストールと使い方

現在、Typstの公式パッケージリスト（Preview）への登録を申請中ですが、Gitから直接インポートして使うことができます。あるいは、ローカルパスを指定しても使えます。

```typst
#import "@preview/hundouk:0.1.0": *

// 初期化（フォント設定など）
#show: hundouk-init

#kundoku(
  vertical: true, // 縦書きモード
  text-size: 14pt,
  [
    子[シ]曰[イハ]ク、学[マナ]ビテ時[トキ]ニ之[コレ]ヲ習[ナラ]フ、亦[マタ]説[ヨロコ]バシカラズヤ。
  ]
)
```

### 今後の展望

現在は基本的な漢文の組版が可能になりましたがが、まだ対応しきれていない特殊な組版需要や複雑なレイアウト（例えば送り仮名を外に置くのか真下に置くのか、返点を外にどれくらい送るのか、改行の位置、引用符＝鈎括弧の配置等）があり、これらも順次対応していきたいと考えています。また、他のツールに並ぶ調整可能のアライメントや、より柔軟で完全なカスタマイズを目指しています。

また、前述のように先行研究では漢文に対する仕様定義的な説明が限定的であり、公開された標準もないため、実際の実装に照らし合わせて真似ることしかできません。その現状を打破するために、漢文専用の組版要件を作るべく、イニシャティヴを立ち上げたいと考えています。とりあえず、レポジトリを設けましたので、kanbun-reqを共に作りましょう！

https://github.com/mkpoli/kanbun-req

## 参考文献

1.  W3C, "Requirements for Japanese Text Layout", <https://www.w3.org/TR/jlreq/>
2.  小林 敏, "漢文の句読点や返り点の配置処理", <https://www.jagat.or.jp/archives/21315>
3.  LaTeX gckanbun package, <https://ctan.org/pkg/gckanbun>
4. 藤田 眞作（1999）漢文の訓点文の組版 http://xymtex.com/fujitas/kanbun/kanbunex.html

## コミュニティ

「くみはんクラブ」というコミュニティを2024年1月に創設し、そこでTypstを始めとする様々な組版の話について議論されています。何かTypstなどを使う上で質問や不明点があれば、ぜひいらしてください。また、そのメンバーが中心となって、Typst Japan Communityを結成し、公式の認可を得てドキュメントの非公式日本語翻訳プロジェクトも始動しました。

<https://discord.gg/dHRaAsBeRY>